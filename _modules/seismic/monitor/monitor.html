

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>seismic.monitor.monitor</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
    <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/seismic/monitor/monitor';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/seismic_logo_small.png" class="logo__image only-light" alt=" - Home"/>
    <script>document.write(`<img src="../../../_static/seismic_logo_small.png" class="logo__image only-dark" alt=" - Home"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../modules/intro.html">
    Introduction: Noise Interferometry with (Partial) Greenâ€™s Function Retrieval
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../modules/get_started.html">
    Getting Started with SeisMIC
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../modules/trace_data.html">
    Trace data
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../modules/correlate.html">
    Compute and Handle Correlations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../modules/corrdb.html">
    Save and Load Correlations
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../../modules/monitor.html">
    Monitor Velocity Changes
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../../modules/API.html">
    SeisMIC API
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../../modules/tutorials.html">
    Our tutorials: From Zero to Noise-Hero
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/PeterMakus/SeisMIC" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../modules/intro.html">
    Introduction: Noise Interferometry with (Partial) Greenâ€™s Function Retrieval
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../modules/get_started.html">
    Getting Started with SeisMIC
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../modules/trace_data.html">
    Trace data
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../modules/correlate.html">
    Compute and Handle Correlations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../modules/corrdb.html">
    Save and Load Correlations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../modules/monitor.html">
    Monitor Velocity Changes
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../modules/API.html">
    SeisMIC API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../modules/tutorials.html">
    Our tutorials: From Zero to Noise-Hero
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/PeterMakus/SeisMIC" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">seismic.moni...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for seismic.monitor.monitor</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">:copyright:</span>
<span class="sd">    The SeisMIC development team (makus@gfz-potsdam.de).</span>
<span class="sd">:license:</span>
<span class="sd">    EUROPEAN UNION PUBLIC LICENCE v. 1.2</span>
<span class="sd">   (https://joinup.ec.europa.eu/collection/eupl/eupl-text-eupl-12)</span>
<span class="sd">:author:</span>
<span class="sd">   Peter Makus (makus@gfz-potsdam.de)</span>

<span class="sd">Created: Thursday, 3rd June 2021 04:15:57 pm</span>
<span class="sd">Last Modified: Tuesday, 9th July 2024 04:48:54 pm</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>

<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">obspy</span> <span class="kn">import</span> <span class="n">UTCDateTime</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">seismic.db.corr_hdf5</span> <span class="kn">import</span> <span class="n">CorrelationDataBase</span><span class="p">,</span> <span class="n">h5_FMTSTR</span>
<span class="kn">from</span> <span class="nn">seismic.monitor.dv</span> <span class="kn">import</span> <span class="n">DV</span><span class="p">,</span> <span class="n">read_dv</span>
<span class="kn">from</span> <span class="nn">seismic.monitor.wfc</span> <span class="kn">import</span> <span class="n">WFC</span>
<span class="kn">from</span> <span class="nn">seismic.utils.miic_utils</span> <span class="kn">import</span> <span class="n">log_lvl</span>


<div class="viewcode-block" id="Monitor"><a class="viewcode-back" href="../../../modules/API/API.html#seismic.monitor.monitor.Monitor">[docs]</a><span class="k">class</span> <span class="nc">Monitor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Object that handles the computation of seismic velocity changes.</span>
<span class="sd">        This will access correlations that have been computed previously with</span>
<span class="sd">        the :class:`~seismic.correlate.correlate.Correlator` class.</span>

<span class="sd">        Takes the parameter file as input (either as yaml or as dict).</span>

<span class="sd">        :param options: Parameters for the monitor. Usually, they come in form</span>
<span class="sd">            of a *yaml* file. If this parameter is a str, it will be</span>
<span class="sd">            interpreted to be the path to said *yaml* file.</span>
<span class="sd">        :type options: dict or str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">options</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">starttimes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endtimes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_starttimes_list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proj_dir</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;proj_dir&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;proj_dir&#39;</span><span class="p">],</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;subdir&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;proj_dir&#39;</span><span class="p">],</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;co&#39;</span><span class="p">][</span><span class="s1">&#39;subdir&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># init MPI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>

        <span class="c1"># directories:</span>
        <span class="n">logdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj_dir</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;log_subdir&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">logdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Logging - rank dependent</span>
        <span class="n">loglvl</span> <span class="o">=</span> <span class="n">log_lvl</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;log_level&#39;</span><span class="p">]]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tstr</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">-%H:%M&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tstr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">tstr</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># replace colon in tstr</span>
        <span class="n">tstr</span> <span class="o">=</span> <span class="n">tstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span>
            <span class="s2">&quot;seismic.monitor.Monitor</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">loglvl</span><span class="p">)</span>

        <span class="c1"># also catch the warnings</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">captureWarnings</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">warnlog</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;py.warnings&#39;</span><span class="p">)</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">logdir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;monitor</span><span class="si">{</span><span class="n">tstr</span><span class="si">}</span><span class="s1">rank</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">loglvl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
        <span class="n">warnlog</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
            <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
        <span class="n">consoleHandler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
        <span class="n">consoleHandler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">consoleHandler</span><span class="p">)</span>

        <span class="c1"># Write the options dictionary to the log file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">opt_dump</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
            <span class="c1"># json cannot write the UTCDateTime objects that might be in here</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">opt_dump</span><span class="p">[</span><span class="s1">&#39;co&#39;</span><span class="p">][</span><span class="s1">&#39;preProcessing&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;stream_mask_at_utc&#39;</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]:</span>
                    <span class="n">startsstr</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">t</span><span class="o">.</span><span class="n">format_fissures</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">][</span><span class="s1">&#39;starts&#39;</span><span class="p">]]</span>
                    <span class="n">step</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">][</span><span class="s1">&#39;starts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">startsstr</span>
                    <span class="k">if</span> <span class="s1">&#39;ends&#39;</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]:</span>
                        <span class="n">endsstr</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">t</span><span class="o">.</span><span class="n">format_fissures</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">][</span><span class="s1">&#39;ends&#39;</span><span class="p">]]</span>
                        <span class="n">step</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">][</span><span class="s1">&#39;ends&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endsstr</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">logdir</span><span class="p">,</span> <span class="s1">&#39;params</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="n">tstr</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">opt_dump</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Find available stations and network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">netlist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">statlist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">infiles</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_find_available_corrs</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_starttimes_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns numpy array of starttimes and endtimes, for which each data</span>
<span class="sd">        point of velocity change should be computed.</span>

<span class="sd">        :return: A numpy array holding the starttimes and endtimes of the</span>
<span class="sd">            computing time windows in seconds (as UTC timestamps).</span>
<span class="sd">        :rtype: Tuple[np.ndarray, np.ndarray]</span>

<span class="sd">        ..seealso:: For complete description,</span>
<span class="sd">            :func:`~seismic.monitor.monitor.make_time_list`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">starttimes</span><span class="p">,</span> <span class="n">endtimes</span> <span class="o">=</span> <span class="n">make_time_list</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;start_date&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;end_date&#39;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;date_inc&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;win_len&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">starttimes</span><span class="p">,</span> <span class="n">endtimes</span>

    <span class="k">def</span> <span class="nf">_find_available_corrs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        1. Finds the files of available correlations.</span>
<span class="sd">        2. Out of those files, it will extract the ones that are requested.</span>

<span class="sd">        :return: list of network combination codes, list of station combination</span>
<span class="sd">            codes, and list of the file paths to their corresponding</span>
<span class="sd">            correlation files.</span>
<span class="sd">        :rtype: Tuple[List[str], List[str], List[str]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">netlist</span><span class="p">,</span> <span class="n">statlist</span><span class="p">,</span> <span class="n">infiles</span> <span class="o">=</span> <span class="n">corr_find_filter</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Found correlation data for the following station &#39;</span>
            <span class="o">+</span> <span class="s1">&#39;and network combinations </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;</span><span class="si">{n}</span><span class="s1">.</span><span class="si">{s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">netlist</span><span class="p">,</span> <span class="n">statlist</span><span class="p">)]))</span>
        <span class="k">return</span> <span class="n">netlist</span><span class="p">,</span> <span class="n">statlist</span><span class="p">,</span> <span class="n">infiles</span>

<div class="viewcode-block" id="Monitor.compute_velocity_change"><a class="viewcode-back" href="../../../modules/API/API.html#seismic.monitor.monitor.Monitor.compute_velocity_change">[docs]</a>    <span class="k">def</span> <span class="nf">compute_velocity_change</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">corr_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">network</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">station</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">location</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">channel</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ref_trcs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the velocity change for a cross (or auto) correlation</span>
<span class="sd">        time-series. This process is executed &quot;per station combination&quot;.</span>
<span class="sd">        Meaning, several processes of this method can be started via MPI</span>
<span class="sd">        and the method</span>
<span class="sd">        :meth:`~seismic.monitor.monitor.Monitor.compute_velocity_change_bulk`,</span>
<span class="sd">        which is the function that should rather be acessed than this one.</span>
<span class="sd">        Data will be written into the defined dv folder and plotted if this</span>
<span class="sd">        option was previously set to True.</span>

<span class="sd">        :param corr_file: File to read the correlation data from.</span>
<span class="sd">        :type corr_file: str</span>
<span class="sd">        :param tag: Tag of the data in the file (almost always `&#39;subdivision&#39;`)</span>
<span class="sd">        :type tag: str</span>
<span class="sd">        :param network: Network combination code</span>
<span class="sd">        :type network: str</span>
<span class="sd">        :param station: Station Combination Code</span>
<span class="sd">        :type station: str</span>
<span class="sd">        :param location: Location combination code</span>
<span class="sd">        :type location: str</span>
<span class="sd">        :param channel: Channel combination code</span>
<span class="sd">        :type channel: str</span>
<span class="sd">        :param ref_trcs: Feed in on or several custom reference traces.</span>
<span class="sd">            If None the program will determine a reference trace from</span>
<span class="sd">            the chosen method in the config. Defaults to None</span>
<span class="sd">        :type ref_trcs: np.ndarray, optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Computing velocity change for file: </span><span class="si">{</span><span class="n">corr_file</span><span class="si">}</span><span class="s1"> and channel: &#39;</span>
            <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">CorrelationDataBase</span><span class="p">(</span><span class="n">corr_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cdb</span><span class="p">:</span>
            <span class="c1"># get the corrstream containing all the corrdata for this combi</span>
            <span class="n">cst</span> <span class="o">=</span> <span class="n">cdb</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
            <span class="n">lts</span> <span class="o">=</span> <span class="n">cdb</span><span class="o">.</span><span class="n">get_corr_options</span><span class="p">()[</span><span class="s1">&#39;corr_args&#39;</span><span class="p">][</span><span class="s1">&#39;lengthToSave&#39;</span><span class="p">]</span>

        <span class="n">tw_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;tw_start&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;compute_tt&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">,</span> <span class="s1">&#39;dist&#39;</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">network</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s1"> does not include distance. &#39;</span>
                    <span class="s1">&#39;SeisMIC will assume an interstation distance of 0.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Assume flat earth to include topography</span>
                <span class="c1"># Note that dist is in km and elevation information in m</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                    <span class="n">cst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">dist</span><span class="o">**</span><span class="mi">2</span>
                    <span class="o">+</span> <span class="p">((</span><span class="n">cst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">stel</span><span class="o">-</span><span class="n">cst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">evel</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">tt</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
                    <span class="n">d</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;rayleigh_wave_velocity&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">tw_start</span> <span class="o">+=</span> <span class="n">tt</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Computed travel time for </span><span class="si">{</span><span class="n">network</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s1"> is &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tt</span><span class="si">}</span><span class="s1"> s. The assumed direct-line distance was </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s1"> km.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lts</span> <span class="o">&lt;</span> <span class="n">tw_start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;tw_len&#39;</span><span class="p">]:</span>
            <span class="n">reqtw</span> <span class="o">=</span> <span class="n">tw_start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span>
                <span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;tw_len&#39;</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Requested lapse time window (time window start + time window&#39;</span>
                <span class="sa">f</span><span class="s1">&#39; length = </span><span class="si">{</span><span class="n">reqtw</span><span class="si">}</span><span class="s1"> contains segments after the Correlation&#39;</span>
                <span class="s1">&#39;Function.&#39;</span>
                <span class="s1">&#39; When computing the correlations make sure to set an &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;appropriate value for lengthToSave. The value was </span><span class="si">{</span><span class="n">lts</span><span class="si">}</span><span class="s1">.&#39;</span>
                <span class="sa">f</span><span class="s1">&#39; The direct-line distance between the stations is </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s1"> km.&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;preprocessing&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;preprocessing&#39;</span><span class="p">]:</span>
                <span class="c1"># This one goes on the CorrStream</span>
                <span class="k">if</span> <span class="n">func</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pop_at_utcs&#39;</span><span class="p">,</span> <span class="s1">&#39;select_time&#39;</span><span class="p">]:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">cst</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">func</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">])</span>
                    <span class="n">cst</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">**</span><span class="n">func</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">])</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">cst</span><span class="o">.</span><span class="n">create_corr_bulk</span><span class="p">(</span>
            <span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># for possible rest bits</span>
        <span class="k">del</span> <span class="n">cst</span>
        <span class="c1"># Do the actual processing:</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">normtype</span><span class="o">=</span><span class="s1">&#39;absmax&#39;</span><span class="p">)</span>
        <span class="c1"># That is were the stacking is happening</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">starttimes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endtimes</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;freq_min&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;freq_max&#39;</span><span class="p">]))</span>

        <span class="c1"># Preprocessing on the correlation bulk</span>
        <span class="k">if</span> <span class="s1">&#39;preprocessing&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;preprocessing&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">func</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pop_at_utcs&#39;</span><span class="p">,</span> <span class="s1">&#39;select_time&#39;</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">func</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">])</span>
                <span class="n">cb</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">**</span><span class="n">func</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">])</span>

        <span class="c1"># Retain a copy of the stats</span>
        <span class="n">stats_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">cb</span><span class="o">.</span><span class="n">stats</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;tw_len&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">trim0</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">start_lag</span>
            <span class="n">trim1</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">end_lag</span>
            <span class="n">cbt</span> <span class="o">=</span> <span class="n">cb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trim0</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span>
                <span class="n">tw_start</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;tw_len&#39;</span><span class="p">])</span>
            <span class="n">trim1</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">tw_start</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;tw_len&#39;</span><span class="p">])</span>
            <span class="n">cbt</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">trim0</span><span class="p">,</span> <span class="n">trim1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cbt</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;CorrBulk extremely short.&#39;</span><span class="p">)</span>

        <span class="c1"># 15.11.22</span>
        <span class="c1"># Do trimming after stretching of the reference trace to avoid</span>
        <span class="c1"># edges having an influence on dv/v estimate</span>
        <span class="k">if</span> <span class="n">ref_trcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">extract_multi_trace</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;dt_ref&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="n">ref_trcs</span>

        <span class="c1"># Compute time window</span>
        <span class="n">tw</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="n">tw_start</span><span class="o">*</span><span class="n">cbt</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">],</span>
            <span class="n">trim1</span><span class="o">*</span><span class="n">cbt</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="c1"># 2023/09/29</span>
        <span class="c1"># sim_mat is not required in this operation</span>
        <span class="n">dv</span> <span class="o">=</span> <span class="n">cbt</span><span class="o">.</span><span class="n">stretch</span><span class="p">(</span>
            <span class="n">ref_trc</span><span class="o">=</span><span class="n">tr</span><span class="p">,</span> <span class="n">return_sim_mat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">stretch_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;stretch_steps&#39;</span><span class="p">],</span>
            <span class="n">stretch_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;stretch_range&#39;</span><span class="p">],</span>
            <span class="n">tw</span><span class="o">=</span><span class="n">tw</span><span class="p">,</span> <span class="n">sides</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;sides&#39;</span><span class="p">],</span>
            <span class="n">ref_tr_trim</span><span class="o">=</span><span class="p">(</span><span class="n">trim0</span><span class="p">,</span> <span class="n">trim1</span><span class="p">),</span> <span class="n">ref_tr_stats</span><span class="o">=</span><span class="n">stats_copy</span><span class="p">,</span>
            <span class="n">processing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">])</span>
        <span class="n">ccb</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">correct_stretch</span><span class="p">(</span><span class="n">dv</span><span class="p">)</span>

        <span class="c1"># extract the final reference trace (mean excluding very different</span>
        <span class="c1"># traces)</span>
        <span class="k">if</span> <span class="n">ref_trcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">.</span><span class="n">extract_multi_trace</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;dt_ref&#39;</span><span class="p">])</span>

        <span class="n">ccb</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">trim0</span><span class="p">,</span> <span class="n">trim1</span><span class="p">)</span>

        <span class="c1"># obtain an improved time shift measurement</span>
        <span class="n">dv</span> <span class="o">=</span> <span class="n">cbt</span><span class="o">.</span><span class="n">stretch</span><span class="p">(</span>
            <span class="n">ref_trc</span><span class="o">=</span><span class="n">tr</span><span class="p">,</span> <span class="n">return_sim_mat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;return_sim_mat&#39;</span><span class="p">],</span>
            <span class="n">stretch_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;stretch_steps&#39;</span><span class="p">],</span>
            <span class="n">stretch_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;stretch_range&#39;</span><span class="p">],</span>
            <span class="n">tw</span><span class="o">=</span><span class="n">tw</span><span class="p">,</span> <span class="n">sides</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;sides&#39;</span><span class="p">],</span>
            <span class="n">ref_tr_trim</span><span class="o">=</span><span class="p">(</span><span class="n">trim0</span><span class="p">,</span> <span class="n">trim1</span><span class="p">),</span> <span class="n">ref_tr_stats</span><span class="o">=</span><span class="n">stats_copy</span><span class="p">,</span>
            <span class="n">processing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">])</span>

        <span class="c1"># Postprocessing on the dv object</span>
        <span class="k">if</span> <span class="s1">&#39;postprocessing&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;postprocessing&#39;</span><span class="p">]:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">func</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">])</span>
                <span class="n">dv</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">**</span><span class="n">func</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">])</span>

        <span class="n">outf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;DV-</span><span class="si">{</span><span class="n">network</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">dv</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outf</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;plot_vel_change&#39;</span><span class="p">]:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">network</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">savedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;proj_dir&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;fig_subdir&#39;</span><span class="p">])</span>
            <span class="n">dv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">save_dir</span><span class="o">=</span><span class="n">savedir</span><span class="p">,</span> <span class="n">figure_file_name</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span>
                <span class="n">normalize_simmat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sim_mat_Clim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="Monitor.compute_velocity_change_bulk"><a class="viewcode-back" href="../../../modules/API/API.html#seismic.monitor.monitor.Monitor.compute_velocity_change_bulk">[docs]</a>    <span class="k">def</span> <span class="nf">compute_velocity_change_bulk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the velocity change for all correlations using MPI.</span>
<span class="sd">        The parameters for the correlation defined in the *yaml* file will be</span>
<span class="sd">        used.</span>

<span class="sd">        This function will just call</span>
<span class="sd">        :meth:`~seismic.monitor.monitor.Monitor.compute_velocity_change`</span>
<span class="sd">        several times.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;subdivision&#39;</span>
        <span class="c1"># get number of available channel combis</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">infiles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">netlist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">statlist</span><span class="p">):</span>
                <span class="n">locs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">with</span> <span class="n">CorrelationDataBase</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cdb</span><span class="p">:</span>
                    <span class="n">ch</span> <span class="o">=</span> <span class="n">cdb</span><span class="o">.</span><span class="n">get_available_channels</span><span class="p">(</span>
                        <span class="n">tag</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">locs</span><span class="p">)</span>
                    <span class="n">plist</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">f</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">locs</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ch</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">plist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">plist</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plist</span><span class="p">))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">plist</span><span class="p">)</span>
        <span class="n">pmap</span> <span class="o">=</span> <span class="n">pmap</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">pmap</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plist</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="n">ind</span><span class="p">]</span>

        <span class="c1"># Assign a task to each rank</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
            <span class="n">corr_file</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">cha</span> <span class="o">=</span> <span class="n">plist</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compute_velocity_change</span><span class="p">(</span>
                    <span class="n">corr_file</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">cha</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;No correlation data found for </span><span class="si">{</span><span class="n">net</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">stat</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">loc</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">cha</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;with tag </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1"> in file </span><span class="si">{</span><span class="n">corr_file</span><span class="si">}</span><span class="s1">.&#39;</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1"> for file </span><span class="si">{</span><span class="n">corr_file</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Monitor.compute_components_average"><a class="viewcode-back" href="../../../modules/API/API.html#seismic.monitor.monitor.Monitor.compute_components_average">[docs]</a>    <span class="k">def</span> <span class="nf">compute_components_average</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;AutoComponents&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Averages the Similarity matrix of different velocity changes in</span>
<span class="sd">        the whole dv folder. Based upon those values, new dvs and correlations</span>
<span class="sd">        are computed.</span>

<span class="sd">        :param method: Which components should be averaged? Can be</span>
<span class="sd">            &#39;StationWide&#39; if all component-combinations for one station should</span>
<span class="sd">            be averaged, &#39;AutoComponents&#39; if only the dv results of</span>
<span class="sd">            autocorrelations are to be averaged, &#39;CrossComponents&#39; if you wish</span>
<span class="sd">            to average dvs from the same station but only intercomponent</span>
<span class="sd">            corrrelations, or &#39;CrossStations&#39; if cross-station correlations</span>
<span class="sd">            should be averaged (same station combination and all component</span>
<span class="sd">            combinations).</span>
<span class="sd">            Defaults to &#39;AutoComponents&#39;</span>
<span class="sd">        :type method: str, optional</span>
<span class="sd">        :raises ValueError: For Unknown combination methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">av_methods</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;autocomponents&#39;</span><span class="p">,</span> <span class="s1">&#39;crosscomponents&#39;</span><span class="p">,</span> <span class="s1">&#39;stationwide&#39;</span><span class="p">,</span>
            <span class="s1">&#39;crossstations&#39;</span><span class="p">,</span> <span class="s1">&#39;betweenstations&#39;</span><span class="p">,</span> <span class="s1">&#39;betweencomponents&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">av_methods</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Averaging method not in </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">av_methods</span><span class="p">))</span>
        <span class="n">infiles</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;*.npz&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;autocomponents&#39;</span><span class="p">:</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="s1">&#39;av-auto&#39;</span>
        <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;betweencomponents&#39;</span><span class="p">,</span> <span class="s1">&#39;crosscomponents&#39;</span><span class="p">):</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="s1">&#39;av-xc&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="s1">&#39;av&#39;</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">infiles</span><span class="p">):</span>
            <span class="c1"># Find files belonging to same station</span>
            <span class="n">pat</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">infiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span>
            <span class="n">filtfil</span> <span class="o">=</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">infiles</span><span class="p">,</span> <span class="n">pat</span><span class="p">)</span>
            <span class="n">fffil</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Second filter</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filtfil</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                    <span class="c1"># Is already computed for this station</span>
                    <span class="c1"># So let&#39;s remove all of them from the initial list</span>
                    <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">filtfil</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">infiles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="c1"># Has already been removed by one of the other</span>
                            <span class="c1"># check</span>
                            <span class="k">pass</span>
                    <span class="n">filtfil</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="n">fffil</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Skipping already averaged dv...</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s1">&#39;av&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="c1"># computed by another averaging method</span>
                    <span class="n">infiles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">components</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                <span class="n">locations</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                <span class="n">stations</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;autocomponents&#39;</span><span class="p">:</span>
                    <span class="c1"># Remove those from combined channels</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                            <span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">components</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">locations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">locations</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">stations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">stations</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">infiles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span>
                        <span class="s1">&#39;betweencomponents&#39;</span><span class="p">,</span> <span class="s1">&#39;crosscomponents&#39;</span><span class="p">):</span>
                    <span class="c1"># Remove those from equal channels</span>
                    <span class="n">components</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">components</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> \
                            <span class="ow">or</span> <span class="n">stations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">stations</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">infiles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;stationwide&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">stations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">stations</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">infiles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;betweenstations&#39;</span><span class="p">,</span> <span class="s1">&#39;crossstations&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">stations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">stations</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">infiles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="n">fffil</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">dvs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fffil</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">read_dv</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                        <span class="s1">&#39;An unexpected error has ocurred &#39;</span>
                        <span class="o">+</span> <span class="s1">&#39;while reading file </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
                <span class="c1"># Remove so they are not processed again</span>
                <span class="n">infiles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">dvs</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">dvs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s1">&#39;Only component </span><span class="si">%s</span><span class="s1"> found for station </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">... Skipping.&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">dvs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">dvs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                        <span class="n">dvs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="n">dv_av</span> <span class="o">=</span> <span class="n">average_components</span><span class="p">(</span><span class="n">dvs</span><span class="p">)</span>
            <span class="n">outf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;DV-</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">dv_av</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="n">dv_av</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span>
            <span class="n">dv_av</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outf</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dv&#39;</span><span class="p">][</span><span class="s1">&#39;plot_vel_change&#39;</span><span class="p">]:</span>
                <span class="c1"># plot if desired</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">dv_av</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="n">dv_av</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>
                <span class="n">savedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;proj_dir&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;fig_subdir&#39;</span><span class="p">])</span>
                <span class="n">dv_av</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">save_dir</span><span class="o">=</span><span class="n">savedir</span><span class="p">,</span> <span class="n">figure_file_name</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span>
                    <span class="n">normalize_simmat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sim_mat_Clim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="Monitor.compute_waveform_coherence_bulk"><a class="viewcode-back" href="../../../modules/API/API.html#seismic.monitor.monitor.Monitor.compute_waveform_coherence_bulk">[docs]</a>    <span class="k">def</span> <span class="nf">compute_waveform_coherence_bulk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the WFC for all specified (params file) correlations using MPI.</span>
<span class="sd">        The parameters for the correlation defined in the *yaml* file will be</span>
<span class="sd">        used.</span>

<span class="sd">        This function will just call</span>
<span class="sd">        :meth:`~seismic.monitor.monitor.Monitor.compute_waveform_coherence`</span>
<span class="sd">        several times.</span>
<span class="sd">        Subsequently, the average of the different component combinations will</span>
<span class="sd">        be computed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;subdivision&#39;</span>
        <span class="c1"># get number of available channel combis</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">infiles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">netlist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">statlist</span><span class="p">):</span>
                <span class="n">locs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">with</span> <span class="n">CorrelationDataBase</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cdb</span><span class="p">:</span>
                    <span class="n">ch</span> <span class="o">=</span> <span class="n">cdb</span><span class="o">.</span><span class="n">get_available_channels</span><span class="p">(</span>
                        <span class="n">tag</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">locs</span><span class="p">)</span>
                    <span class="n">plist</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">f</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">locs</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ch</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">plist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">plist</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plist</span><span class="p">))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">plist</span><span class="p">)</span>
        <span class="n">pmap</span> <span class="o">=</span> <span class="n">pmap</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">pmap</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plist</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="n">ind</span><span class="p">]</span>

        <span class="c1"># Assign a task to each rank</span>
        <span class="n">wfcl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
            <span class="n">corr_file</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">cha</span> <span class="o">=</span> <span class="n">plist</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">wfc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_waveform_coherence</span><span class="p">(</span>
                    <span class="n">corr_file</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">cha</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">wfcl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wfc</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;proj_dir&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;subdir&#39;</span><span class="p">])</span>
        <span class="c1"># Compute averages and everything</span>
        <span class="n">wfclu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allgather</span><span class="p">(</span><span class="n">wfcl</span><span class="p">)</span>
        <span class="c1"># concatenate</span>
        <span class="n">wfcl</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wfclu</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">wfclu</span>

        <span class="c1"># Find unique averaging groups</span>
        <span class="n">wfc_avl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">wfc</span> <span class="ow">in</span> <span class="n">wfcl</span><span class="p">:</span>
            <span class="n">wfc_avl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">wfc</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="n">wfc</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span>
                    <span class="n">wfc</span><span class="o">.</span><span class="n">wfc_processing</span><span class="p">[</span><span class="s1">&#39;freq_min&#39;</span><span class="p">],</span>
                    <span class="n">wfc</span><span class="o">.</span><span class="n">wfc_processing</span><span class="p">[</span><span class="s1">&#39;freq_max&#39;</span><span class="p">],</span>
                    <span class="n">wfc</span><span class="o">.</span><span class="n">wfc_processing</span><span class="p">[</span><span class="s1">&#39;tw_start&#39;</span><span class="p">],</span>
                    <span class="n">wfc</span><span class="o">.</span><span class="n">wfc_processing</span><span class="p">[</span><span class="s1">&#39;tw_len&#39;</span><span class="p">]))</span>
        <span class="n">wfc_avl</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">wfc_avl</span><span class="p">))</span>
        <span class="n">wfcl_sub</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">avl</span> <span class="ow">in</span> <span class="n">wfc_avl</span><span class="p">:</span>
            <span class="n">net</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">tw_start</span><span class="p">,</span> <span class="n">tw_len</span> <span class="o">=</span> <span class="n">avl</span>
            <span class="n">wfcl_sub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">wfc</span> <span class="k">for</span> <span class="n">wfc</span> <span class="ow">in</span> <span class="n">wfcl</span> <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">wfc</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span> <span class="o">==</span> <span class="n">net</span><span class="p">,</span> <span class="n">wfc</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span> <span class="o">==</span> <span class="n">stat</span><span class="p">,</span>
                        <span class="n">wfc</span><span class="o">.</span><span class="n">wfc_processing</span><span class="p">[</span><span class="s1">&#39;freq_min&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fmin</span><span class="p">,</span>
                        <span class="n">wfc</span><span class="o">.</span><span class="n">wfc_processing</span><span class="p">[</span><span class="s1">&#39;freq_max&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fmax</span><span class="p">,</span>
                        <span class="n">wfc</span><span class="o">.</span><span class="n">wfc_processing</span><span class="p">[</span><span class="s1">&#39;tw_start&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tw_start</span><span class="p">,</span>
                        <span class="n">wfc</span><span class="o">.</span><span class="n">wfc_processing</span><span class="p">[</span><span class="s1">&#39;tw_len&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tw_len</span>
                    <span class="p">])])</span>
        <span class="k">for</span> <span class="n">wfc_avl</span> <span class="ow">in</span> <span class="n">wfcl_sub</span><span class="p">:</span>
            <span class="n">wfc</span> <span class="o">=</span> <span class="n">average_components_wfc</span><span class="p">(</span><span class="n">wfc_avl</span><span class="p">)</span>
            <span class="c1"># Write files</span>
            <span class="n">outf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;WFC-</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.f</span><span class="si">%a</span><span class="s1">-</span><span class="si">%a</span><span class="s1">.tw</span><span class="si">%a</span><span class="s1">-</span><span class="si">%a</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">wfc</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="n">wfc</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="n">wfc</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
                <span class="n">wfc</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span>
                <span class="n">wfc</span><span class="o">.</span><span class="n">wfc_processing</span><span class="p">[</span><span class="s1">&#39;freq_min&#39;</span><span class="p">],</span>
                <span class="n">wfc</span><span class="o">.</span><span class="n">wfc_processing</span><span class="p">[</span><span class="s1">&#39;freq_max&#39;</span><span class="p">],</span>
                <span class="n">wfc</span><span class="o">.</span><span class="n">wfc_processing</span><span class="p">[</span><span class="s1">&#39;tw_start&#39;</span><span class="p">],</span>
                <span class="n">wfc</span><span class="o">.</span><span class="n">wfc_processing</span><span class="p">[</span><span class="s1">&#39;tw_len&#39;</span><span class="p">]))</span>
            <span class="n">wfc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outf</span><span class="p">)</span></div>

<div class="viewcode-block" id="Monitor.compute_waveform_coherence"><a class="viewcode-back" href="../../../modules/API/API.html#seismic.monitor.monitor.Monitor.compute_waveform_coherence">[docs]</a>    <span class="k">def</span> <span class="nf">compute_waveform_coherence</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">corr_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">network</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">station</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span>
            <span class="n">channel</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WFC</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the waveform coherence corresponding to one correlation (i.e.,</span>
<span class="sd">        one single file).</span>

<span class="sd">        The waveform coherence can be used as a measure of stability of</span>
<span class="sd">        a certain correlation. See Steinmann, et. al. (2021) for details.</span>

<span class="sd">        :param corr_file: File to compute the wfc from</span>
<span class="sd">        :type corr_file: str</span>
<span class="sd">        :param tag: Tag inside of hdf5 file to retrieve corrs from.</span>
<span class="sd">        :type tag: str</span>
<span class="sd">        :param network: Network combination code.</span>
<span class="sd">        :type network: str</span>
<span class="sd">        :param station: Station combination code</span>
<span class="sd">        :type station: str</span>
<span class="sd">        :param location: Location combination code</span>
<span class="sd">        :type location: str</span>
<span class="sd">        :param channel: Channel combination code.</span>
<span class="sd">        :type channel: str</span>
<span class="sd">        :raises ValueError: For short correlations</span>
<span class="sd">        :return: An object holding the waveform coherence</span>
<span class="sd">        :rtype: :class:`~seismic.monitor.wfc.WFC`</span>

<span class="sd">        .. seealso:: To compute wfc for several correlations use:</span>
<span class="sd">            :meth:`~seismic.monitor.monitor.Monitor.compute.waveform_coherence\</span>
<span class="sd">            _bulk`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing wfc for file: </span><span class="si">%s</span><span class="s1"> and channel: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">corr_file</span><span class="p">,</span> <span class="n">channel</span><span class="p">))</span>
        <span class="k">with</span> <span class="n">CorrelationDataBase</span><span class="p">(</span><span class="n">corr_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cdb</span><span class="p">:</span>
            <span class="c1"># get the corrstream containing all the corrdata for this combi</span>
            <span class="n">cst</span> <span class="o">=</span> <span class="n">cdb</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
                <span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;preprocessing&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;preprocessing&#39;</span><span class="p">]:</span>
                <span class="c1"># This one goes on the CorrStream</span>
                <span class="k">if</span> <span class="n">func</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pop_at_utcs&#39;</span><span class="p">,</span> <span class="s1">&#39;select_time&#39;</span><span class="p">]:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">cst</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">func</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">])</span>
                    <span class="n">cst</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">**</span><span class="n">func</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">])</span>

        <span class="n">cb</span> <span class="o">=</span> <span class="n">cst</span><span class="o">.</span><span class="n">create_corr_bulk</span><span class="p">(</span>
            <span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;proj_dir&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;subdir&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># for possible rest bits</span>
        <span class="k">del</span> <span class="n">cst</span>
        <span class="c1"># Do the actual processing:</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">normtype</span><span class="o">=</span><span class="s1">&#39;absmax&#39;</span><span class="p">)</span>
        <span class="c1"># That is were the stacking is happening</span>
        <span class="n">starttimes</span><span class="p">,</span> <span class="n">endtimes</span> <span class="o">=</span> <span class="n">make_time_list</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;start_date&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;end_date&#39;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;date_inc&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;win_len&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Timelist created.&#39;</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">starttimes</span><span class="p">,</span> <span class="n">endtimes</span><span class="p">)</span>

        <span class="c1"># Allow lists so the computation does not have to be started x times</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;freq_min&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;freq_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;freq_min&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;freq_max&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;freq_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;freq_max&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;freq_min&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;freq_max&#39;</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;freq_min and freq_max must be of same length.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;tw_start&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;tw_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;tw_start&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;tw_len&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;tw_len&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;tw_start&#39;</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;tw_start and tw_len must be of same length or tw_len must be&#39;</span>
                <span class="s1">&#39; a single value.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;tw_len&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;tw_len&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;tw_len&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;tw_start&#39;</span><span class="p">])</span>

        <span class="n">cb_bac</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;freq_min&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;freq_max&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">fmin</span> <span class="o">&gt;=</span> <span class="n">fmax</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;freq_min must be smaller than freq_max.&#39;</span><span class="p">)</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="p">))</span>

            <span class="c1"># Preprocessing on the correlation bulk</span>
            <span class="k">if</span> <span class="s1">&#39;preprocessing&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;preprocessing&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">func</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pop_at_utcs&#39;</span><span class="p">,</span> <span class="s1">&#39;select_time&#39;</span><span class="p">]:</span>
                        <span class="k">continue</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">func</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">])</span>
                    <span class="n">cb</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">**</span><span class="n">func</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Preprocessing finished. Computing wfc for fmin: </span><span class="si">{</span><span class="n">fmin</span><span class="si">}</span><span class="s1"> &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;and fmax: </span><span class="si">{</span><span class="n">fmax</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;wfc&quot;</span><span class="p">][</span><span class="s2">&quot;tw_start&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;time windows.&#39;</span><span class="p">)</span>

            <span class="c1"># Now, we loop over the time windows</span>
            <span class="k">for</span> <span class="n">tw_start</span><span class="p">,</span> <span class="n">tw_len</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;tw_start&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;tw_len&#39;</span><span class="p">]):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Now, we make a copy of the cm to be trimmed</span>
                    <span class="n">cbt</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span>
                        <span class="o">-</span><span class="p">(</span><span class="n">tw_start</span> <span class="o">+</span> <span class="n">tw_len</span><span class="p">),</span> <span class="n">tw_start</span> <span class="o">+</span> <span class="n">tw_len</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">cbt</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;CorrBulk extremely short.&#39;</span><span class="p">)</span>

                    <span class="n">tr</span> <span class="o">=</span> <span class="n">cbt</span><span class="o">.</span><span class="n">extract_multi_trace</span><span class="p">(</span>
                        <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;dt_ref&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s1">&#39;Reference trace created.</span><span class="se">\n</span><span class="s1">Computing WFC...&#39;</span><span class="p">)</span>

                    <span class="c1"># Compute time window</span>
                    <span class="n">tw</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                        <span class="n">tw_start</span><span class="o">*</span><span class="n">cbt</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">],</span>
                        <span class="p">(</span><span class="n">tw_start</span><span class="o">+</span><span class="n">tw_len</span><span class="p">)</span><span class="o">*</span><span class="n">cbt</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)]</span>
                    <span class="n">wfc</span> <span class="o">=</span> <span class="n">cbt</span><span class="o">.</span><span class="n">wfc</span><span class="p">(</span>
                        <span class="n">tr</span><span class="p">,</span> <span class="n">tw</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">tw_start</span><span class="p">,</span> <span class="n">tw_len</span><span class="p">,</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s1">&#39;WFC computed.</span><span class="se">\n</span><span class="s1">Averaging over time axis...&#39;</span><span class="p">)</span>
                    <span class="c1"># Compute the average over the whole time window</span>
                    <span class="n">wfc</span><span class="o">.</span><span class="n">compute_average</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;wfc&#39;</span><span class="p">][</span><span class="s1">&#39;save_comps&#39;</span><span class="p">]:</span>
                        <span class="n">outf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;WFC-</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.f</span><span class="si">%a</span><span class="s1">-</span><span class="si">%a</span><span class="s1">.tw</span><span class="si">%a</span><span class="s1">-</span><span class="si">%a</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
                                <span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">tw_start</span><span class="p">,</span> <span class="n">tw_len</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Writing WFC to </span><span class="si">{</span><span class="n">outf</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">wfc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outf</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">wfc</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s1">&#39;Error computing WFC for fmin: &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fmin</span><span class="si">}</span><span class="s1"> and fmax: </span><span class="si">{</span><span class="n">fmax</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39; and tw_start: </span><span class="si">{</span><span class="n">tw_start</span><span class="si">}</span><span class="s1"> and tw_len: </span><span class="si">{</span><span class="n">tw_len</span><span class="si">}</span><span class="s1">. &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">cb_bac</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="make_time_list"><a class="viewcode-back" href="../../../modules/API/API.html#seismic.monitor.monitor.make_time_list">[docs]</a><span class="k">def</span> <span class="nf">make_time_list</span><span class="p">(</span>
    <span class="n">start_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">date_inc</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">win_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns numpy array of starttimes and endtimes, for which each data point</span>
<span class="sd">    of velocity change should be computed.</span>

<span class="sd">    :param start_date: Date (including time) to start monitoring</span>
<span class="sd">    :type start_date: str</span>
<span class="sd">    :param end_date: Last date (including time) of monitoring</span>
<span class="sd">    :type end_date: str</span>
<span class="sd">    :param date_inc: Increment in seconds between each datapoint</span>
<span class="sd">    :type date_inc: int</span>
<span class="sd">    :param win_len: Window Length, for which each data point is computed.</span>
<span class="sd">    :type win_len: int</span>
<span class="sd">    :return: A numpy array holding the starttimes and endtimes of the computing</span>
<span class="sd">        time windows in seconds (as UTC timestamps)</span>
<span class="sd">    :rtype: Tuple[ np.ndarray, np.ndarray]</span>

<span class="sd">    ..note::</span>

<span class="sd">        see `obspy&#39;s documentation</span>
<span class="sd">        &lt;https://docs.obspy.org/packages/autogen/obspy.core.utcdatetime.UTCDateTime.html&gt;`</span>
<span class="sd">        for compatible input strings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">date_inc</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">win_len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;Negative increments or window length are not allowed.&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="n">start_date</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="n">end_date</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span>
    <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Start Date should be earlier than end date.&#39;</span><span class="p">)</span>
    <span class="n">inc</span> <span class="o">=</span> <span class="n">date_inc</span>
    <span class="n">starttimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">inc</span><span class="p">)</span>
    <span class="n">endtimes</span> <span class="o">=</span> <span class="n">starttimes</span> <span class="o">+</span> <span class="n">win_len</span>
    <span class="k">return</span> <span class="n">starttimes</span><span class="p">,</span> <span class="n">endtimes</span></div>


<div class="viewcode-block" id="corr_find_filter"><a class="viewcode-back" href="../../../modules/API/API.html#seismic.monitor.monitor.corr_find_filter">[docs]</a><span class="k">def</span> <span class="nf">corr_find_filter</span><span class="p">(</span>
    <span class="n">indir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">net</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    1. Finds the files of available correlations.</span>
<span class="sd">    2. Out of those files, it will extract the ones that are requested.</span>

<span class="sd">    :param indir: Directory that the correlations are saved in.</span>
<span class="sd">    :type indir: str</span>
<span class="sd">    :param net: Network dictionary from *yaml* file.</span>
<span class="sd">    :type net: dict</span>
<span class="sd">    :return: list of network combination codes, list of station combination</span>
<span class="sd">        codes, and list of the file paths to their corresponding</span>
<span class="sd">        correlation files.</span>
<span class="sd">    :rtype: Tuple[List[str], List[str], List[str]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="s1">&#39;??&#39;</span> <span class="o">+</span> <span class="n">net</span><span class="p">[</span><span class="s1">&#39;component&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
    <span class="n">netlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">statlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">infiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">h5_FMTSTR</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">dir</span><span class="o">=</span><span class="n">indir</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">)):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">split</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

        <span class="c1"># Find the files that should actually be processed</span>
        <span class="n">nsplit</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)))</span>
        <span class="n">ssplit</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)))</span>
        <span class="n">csplit</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">net</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">nsplit</span><span class="p">,</span> <span class="n">net</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">nsplit</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">net</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># account for the case of wildcards in the network list</span>
            <span class="n">matchlen</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">net</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">nsplit</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">matchlen</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">matchlen</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">nsplit</span><span class="p">):</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">matchlen</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">nsplit</span><span class="p">):</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">net</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">ssplit</span><span class="p">,</span> <span class="n">net</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">ssplit</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">net</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># account for the case of wildcards in the station list</span>
            <span class="n">matchlen</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">net</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ssplit</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">matchlen</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">matchlen</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ssplit</span><span class="p">):</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">matchlen</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ssplit</span><span class="p">):</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">csplit</span><span class="p">,</span> <span class="n">comp</span><span class="p">)</span> <span class="o">==</span> <span class="n">csplit</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">netlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">statlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">infiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">netlist</span><span class="p">,</span> <span class="n">statlist</span><span class="p">,</span> <span class="n">infiles</span></div>


<div class="viewcode-block" id="correct_dv_shift"><a class="viewcode-back" href="../../../modules/API/API.html#seismic.monitor.monitor.correct_dv_shift">[docs]</a><span class="k">def</span> <span class="nf">correct_dv_shift</span><span class="p">(</span>
    <span class="n">dv0</span><span class="p">:</span> <span class="n">DV</span><span class="p">,</span> <span class="n">dv1</span><span class="p">:</span> <span class="n">DV</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span>
        <span class="n">n_overlap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">DV</span><span class="p">,</span> <span class="n">DV</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Shift dv0 with respect to dv1, so that the same times will have the same</span>
<span class="sd">    value.</span>

<span class="sd">    .. note::</span>
<span class="sd">        in-place operation.</span>

<span class="sd">    :param dv0: DV object to be shifted</span>
<span class="sd">    :type dv0: DV</span>
<span class="sd">    :param dv1: DV object to compare to</span>
<span class="sd">    :type dv1: DV</span>
<span class="sd">    :param method: either mean or median, defaults to &#39;mean&#39;. If mean is chosen</span>
<span class="sd">        the points will be weighted by the correlation coefficient.</span>
<span class="sd">    :type method: str, optional</span>
<span class="sd">    :param n_overlap: Number of points to compare to beyond the</span>
<span class="sd">        already overlapping point. Makes sense if, e.g., one station replaces</span>
<span class="sd">        the other, defaults to 0.</span>
<span class="sd">    :type n_overlap: int, optional</span>
<span class="sd">    :raises ValueError: If the two dvs only have non-nan value more than</span>
<span class="sd">        n_overlap apart.</span>
<span class="sd">    :return: The two dv object. Only the first one is modified. Modification</span>
<span class="sd">        also happens in-place.</span>
<span class="sd">    :rtype: Tuple[DV, DV]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Times when both measured</span>
    <span class="n">both_avail</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">dv0</span><span class="o">.</span><span class="n">avail</span><span class="p">,</span> <span class="n">dv1</span><span class="o">.</span><span class="n">avail</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">both_avail</span><span class="p">):</span>
        <span class="c1"># Unless one of them become less than 0 or more than length</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">both_avail</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">n_overlap</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">both_avail</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">n_overlap</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">jj</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dv0</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">)[</span><span class="n">dv0</span><span class="o">.</span><span class="n">avail</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dv1</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">)[</span><span class="n">dv1</span><span class="o">.</span><span class="n">avail</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="c1"># dv0 comes after dv1:</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dv0</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">dv0</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">)[</span><span class="n">dv0</span><span class="o">.</span><span class="n">avail</span><span class="p">][</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="n">n_overlap</span>
        <span class="n">jj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dv1</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">dv1</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">)[</span><span class="n">dv1</span><span class="o">.</span><span class="n">avail</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">jj</span> <span class="o">-</span> <span class="n">n_overlap</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># dv1 comes after dv0:</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dv1</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">dv1</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">)[</span><span class="n">dv1</span><span class="o">.</span><span class="n">avail</span><span class="p">][</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="n">n_overlap</span>
        <span class="n">jj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dv0</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">dv0</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">)[</span><span class="n">dv0</span><span class="o">.</span><span class="n">avail</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">jj</span> <span class="o">-</span> <span class="n">n_overlap</span>
    <span class="k">if</span> <span class="n">ii</span><span class="o">-</span><span class="n">jj</span> <span class="o">&gt;</span> <span class="n">n_overlap</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;The gap in active times of the two DVs is larger than &#39;</span>
            <span class="s1">&#39;n_overlap, i.e., &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n_overlap</span><span class="o">*</span><span class="p">(</span><span class="n">dv0</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">dv0</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">3600</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="s1">&#39;hours. The result would not make sense.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stop</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dv0</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dv0</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dv0c</span> <span class="o">=</span> <span class="n">dv0</span><span class="o">.</span><span class="n">corr</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
    <span class="n">dv0v</span> <span class="o">=</span> <span class="n">dv0</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
    <span class="n">dv1c</span> <span class="o">=</span> <span class="n">dv1</span><span class="o">.</span><span class="n">corr</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
    <span class="n">dv1v</span> <span class="o">=</span> <span class="n">dv1</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">dv0v</span><span class="o">*</span><span class="n">dv0c</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">dv0c</span><span class="p">)</span>\
            <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">dv1v</span><span class="o">*</span><span class="n">dv1c</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">dv1c</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span>
            <span class="n">dv0</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">dv1</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Method has to be either mean or median&#39;</span><span class="p">)</span>
    <span class="n">roll</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="o">/</span><span class="p">(</span><span class="n">dv0</span><span class="o">.</span><span class="n">second_axis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">dv0</span><span class="o">.</span><span class="n">second_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="n">dv0</span><span class="o">.</span><span class="n">sim_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">dv0</span><span class="o">.</span><span class="n">sim_mat</span><span class="p">,</span> <span class="p">(</span><span class="n">roll</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">dv0</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">dv0</span><span class="o">.</span><span class="n">second_axis</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">dv0</span><span class="o">.</span><span class="n">sim_mat</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">dv0</span><span class="p">,</span> <span class="n">dv1</span></div>


<div class="viewcode-block" id="correct_time_shift_several"><a class="viewcode-back" href="../../../modules/API/API.html#seismic.monitor.monitor.correct_time_shift_several">[docs]</a><span class="k">def</span> <span class="nf">correct_time_shift_several</span><span class="p">(</span><span class="n">dvs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DV</span><span class="p">],</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n_overlap</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Suppose you have a number of dv/v time series from the same location,</span>
<span class="sd">    but station codes changed several times. To stitch these together,</span>
<span class="sd">    this code will iteratively shift each progressive time-series to the</span>
<span class="sd">    shift of the end of its precessor.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The shifting correction happens in-place.</span>

<span class="sd">    :param dvs: List of dvs to be shifted</span>
<span class="sd">    :type dvs: List[DV]</span>
<span class="sd">    :param method: method to be used to measure the shift. Can be &#39;mean&#39; or</span>
<span class="sd">        &#39;median&#39;. If &#39;mean&#39; is chosen, the points will be weighted by their</span>
<span class="sd">        respective correlation coefficient.</span>
<span class="sd">    :type method: str</span>
<span class="sd">    :param n_overlap: amount of points beyond the overlap to use to compute</span>
<span class="sd">        the shift.</span>
<span class="sd">    :type n_overlap: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If three different time-series are provided, find the one that</span>
    <span class="c1"># spans the middle time</span>
    <span class="n">avl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">t</span><span class="o">.</span><span class="n">timestamp</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">dv</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">corr_start</span><span class="p">])[</span>
                <span class="n">dv</span><span class="o">.</span><span class="n">avail</span><span class="p">])</span> <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">dvs</span><span class="p">])</span>
    <span class="n">avl_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">avl</span><span class="p">))</span>
    <span class="c1"># Loop over each unique start and shift and correct them iteratively</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">avstart</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">avl_u</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">avl_u</span><span class="p">):</span>
            <span class="c1"># everything is shifted</span>
            <span class="k">break</span>
        <span class="n">ii_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">avl</span> <span class="o">==</span> <span class="n">avstart</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ii_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">avl</span> <span class="o">==</span> <span class="n">avl_u</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">dv_r</span> <span class="o">=</span> <span class="n">dvs</span><span class="p">[</span><span class="n">ii_ref</span><span class="p">]</span>
        <span class="n">dv_corr</span> <span class="o">=</span> <span class="p">[</span><span class="n">dvs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ii_corr</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">dv_corr</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># The correction should happen in-place</span>
                <span class="n">correct_dv_shift</span><span class="p">(</span>
                    <span class="n">dv</span><span class="p">,</span> <span class="n">dv_r</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                    <span class="n">n_overlap</span><span class="o">=</span><span class="n">n_overlap</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">dv</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> and reference dv &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dv_r</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="average_components_mem_save"><a class="viewcode-back" href="../../../modules/API/API.html#seismic.monitor.monitor.average_components_mem_save">[docs]</a><span class="k">def</span> <span class="nf">average_components_mem_save</span><span class="p">(</span>
        <span class="n">dvs</span><span class="p">:</span> <span class="n">Generator</span><span class="p">[</span><span class="n">DV</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">save_scatter</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DV</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Averages the Similariy matrix of the DV objects. Based on those,</span>
<span class="sd">    it computes a new dv value and a new correlation value. Less memory intense</span>
<span class="sd">    but slower than :func:`average_components`. Should be used if you run</span>
<span class="sd">    out of memory using the former. Uses the sum of squares rule for the</span>
<span class="sd">    standard deviation.</span>

<span class="sd">    :param dvs: Iterator over dvs from the different components to compute an</span>
<span class="sd">        average from. Note that it is possible to use almost anything as</span>
<span class="sd">        input as long as the similarity matrices of the dvs have the same shape</span>
<span class="sd">    :type dvs: Iterator[class:`~seismic.monitor.dv.DV`]</span>
<span class="sd">    :param save_scatter: Saves the scattering of old values and correlation</span>
<span class="sd">        coefficients to later provide a statistical measure. Defaults to True.</span>
<span class="sd">    :type save_scatter: bool, optional</span>
<span class="sd">    :raises TypeError: for DVs that were computed with different methods</span>
<span class="sd">    :return: A single dv with an averaged similarity matrix.</span>
<span class="sd">    :rtype: DV</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">statsl</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">corrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stretches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">dv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dvs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sim_mat_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">sim_mat</span><span class="p">)</span>
            <span class="n">n_stat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">corr</span><span class="p">)</span>

            <span class="n">stats</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">stats</span><span class="p">)</span>
            <span class="n">strvec</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">second_axis</span>
            <span class="n">value_type</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">value_type</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">method</span>
            <span class="n">dv_processing</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">dv_processing</span>
        <span class="k">if</span> <span class="n">dv</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="n">method</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;DV has to be computed with the same method.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;av&#39;</span> <span class="ow">in</span> <span class="n">dv</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="o">+</span><span class="n">dv</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="o">+</span><span class="n">dv</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Averaging of averaged dvs not allowed. Skipping dv&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">dv</span><span class="o">.</span><span class="n">sim_mat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">sim_mat_sum</span><span class="o">.</span><span class="n">shape</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">dv</span><span class="o">.</span><span class="n">second_axis</span> <span class="o">!=</span> <span class="n">strvec</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39;The shapes of the similarity matrices of the input DVs &#39;</span>
                <span class="o">+</span> <span class="s1">&#39;vary. Make sure to compute the dvs with the same parameters&#39;</span>
                <span class="o">+</span> <span class="s1">&#39; (i.e., start &amp; end dates, date-inc, stretch increment, &#39;</span>
                <span class="o">+</span> <span class="s1">&#39;and stretch steps.</span><span class="se">\n\n</span><span class="s1">This dv will be skipped&#39;</span>
            <span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">sim_mat_sum</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">sim_mat</span><span class="p">)</span>
        <span class="n">n_stat</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">value</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">save_scatter</span><span class="p">:</span>
            <span class="n">corrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">corr</span><span class="p">)</span>
            <span class="n">stretches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">statsl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">stats</span><span class="p">)</span>
    <span class="c1"># Now inf where it was nan before</span>
    <span class="n">av_sim_mat</span> <span class="o">=</span> <span class="p">(</span><span class="n">sim_mat_sum</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">n_stat</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">av_sim_mat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">av_sim_mat</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="c1"># Now we would have to recompute the dv value and corr value</span>
    <span class="n">iimax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">av_sim_mat</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">av_sim_mat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">strvec</span><span class="p">[</span><span class="n">iimax</span><span class="p">]</span>
    <span class="n">dt</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">corr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">if</span> <span class="n">save_scatter</span><span class="p">:</span>
        <span class="c1"># use sum of square for std</span>
        <span class="n">corrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">corrs</span><span class="p">)</span>
        <span class="n">stretches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stretches</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">corrs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">stretches</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">st</span><span class="o">.</span><span class="n">channel</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">statsl</span><span class="p">])</span> <span class="o">==</span> <span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">):</span>
        <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;av&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">st</span><span class="o">.</span><span class="n">station</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">statsl</span><span class="p">])</span> <span class="o">==</span> <span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">):</span>
        <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;av&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">st</span><span class="o">.</span><span class="n">network</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">statsl</span><span class="p">])</span> <span class="o">==</span> <span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="p">):</span>
        <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;av&#39;</span>
    <span class="n">dvout</span> <span class="o">=</span> <span class="n">DV</span><span class="p">(</span>
        <span class="n">corr</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">value_type</span><span class="p">,</span> <span class="n">av_sim_mat</span><span class="p">,</span> <span class="n">strvec</span><span class="p">,</span>
        <span class="n">method</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">stretches</span><span class="o">=</span><span class="n">stretches</span><span class="p">,</span> <span class="n">corrs</span><span class="o">=</span><span class="n">corrs</span><span class="p">,</span>
        <span class="n">n_stat</span><span class="o">=</span><span class="n">n_stat</span><span class="p">,</span> <span class="n">dv_processing</span><span class="o">=</span><span class="n">dv_processing</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dvout</span></div>


<div class="viewcode-block" id="average_components"><a class="viewcode-back" href="../../../modules/API/API.html#seismic.monitor.monitor.average_components">[docs]</a><span class="k">def</span> <span class="nf">average_components</span><span class="p">(</span>
    <span class="n">dvs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DV</span><span class="p">],</span> <span class="n">save_scatter</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">correct_shift</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">correct_shift_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span>
        <span class="n">correct_shift_overlap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DV</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Averages the Similariy matrix of the DV objects. Based on those,</span>
<span class="sd">    it computes a new dv value and a new correlation value.</span>

<span class="sd">    :param dvs: List of dvs from the different components to compute an</span>
<span class="sd">        average from. Note that it is possible to use almost anything as</span>
<span class="sd">        input as long as the similarity matrices of the dvs have the same shape</span>
<span class="sd">    :type dvs: List[class:`~seismic.monitor.dv.DV`]</span>
<span class="sd">    :param save_scatter: Saves the scattering of old values and correlation</span>
<span class="sd">        coefficients to later provide a statistical measure. Defaults to True.</span>
<span class="sd">    :type save_scatter: bool, optional</span>
<span class="sd">    :param correct_shift: Shift the dvs with respect to each other. This is</span>
<span class="sd">        relevant if not all stations are active all the time and the references</span>
<span class="sd">        are not describing the same state. This only works if stations were</span>
<span class="sd">        active almost simultaneously at least for a bit</span>
<span class="sd">        (i.e., corr-start[n+n_overlap]-corr-start[n])</span>
<span class="sd">    :raises TypeError: for DVs that were computed with different methods</span>
<span class="sd">    :return: A single dv with an averaged similarity matrix.</span>
<span class="sd">    :rtype: DV</span>

<span class="sd">    .. seealso::</span>
<span class="sd">        If you should get an `OutOfMemoryError` consider using</span>
<span class="sd">        :func:`average_components_mem_save`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dv_use</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">dvs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dv</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="n">dvs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;DV has to be computed with the same method.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;av&#39;</span> <span class="ow">in</span> <span class="n">dv</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="o">+</span><span class="n">dv</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="o">+</span><span class="n">dv</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Averaging of averaged dvs not allowed. Skipping dv&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">dv</span><span class="o">.</span><span class="n">sim_mat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">dvs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sim_mat</span><span class="o">.</span><span class="n">shape</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">dv</span><span class="o">.</span><span class="n">second_axis</span> <span class="o">!=</span> <span class="n">dvs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">second_axis</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39;The shapes of the similarity matrices of the input DVs &#39;</span>
                <span class="o">+</span> <span class="s1">&#39;vary. Make sure to compute the dvs with the same parameters&#39;</span>
                <span class="o">+</span> <span class="s1">&#39; (i.e., start &amp; end dates, date-inc, stretch increment, &#39;</span>
                <span class="o">+</span> <span class="s1">&#39;and stretch steps.</span><span class="se">\n\n</span><span class="s1">This dv will be skipped&#39;</span>
            <span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">dv_use</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dv</span><span class="p">)</span>
    <span class="c1"># Correct shift</span>
    <span class="k">if</span> <span class="n">correct_shift</span><span class="p">:</span>
        <span class="n">correct_time_shift_several</span><span class="p">(</span>
            <span class="n">dv_use</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">correct_shift_method</span><span class="p">,</span>
            <span class="n">n_overlap</span><span class="o">=</span><span class="n">correct_shift_overlap</span><span class="p">)</span>
    <span class="n">av_sim_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">([</span><span class="n">dv</span><span class="o">.</span><span class="n">sim_mat</span> <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">dv_use</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Now we would have to recompute the dv value and corr value</span>
    <span class="n">iimax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">av_sim_mat</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">av_sim_mat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">strvec</span> <span class="o">=</span> <span class="n">dv_use</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">second_axis</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">strvec</span><span class="p">[</span><span class="n">iimax</span><span class="p">]</span>
    <span class="n">dt</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">corr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">if</span> <span class="n">save_scatter</span><span class="p">:</span>
        <span class="n">stretches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dv</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">dv_use</span><span class="p">])</span>
        <span class="n">corrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dv</span><span class="o">.</span><span class="n">corr</span> <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">dv_use</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stretches</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">corrs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Number of stations per corr_start</span>
    <span class="n">n_stat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">dv</span><span class="o">.</span><span class="n">avail</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">dv_use</span><span class="p">])</span>
    <span class="n">n_stat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">n_stat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dv_use</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dv</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span> <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">dv_use</span><span class="p">])</span> <span class="o">==</span> <span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">):</span>
        <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;av&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dv</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span> <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">dv_use</span><span class="p">])</span> <span class="o">==</span> <span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">):</span>
        <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;av&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dv</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span> <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">dv_use</span><span class="p">])</span> <span class="o">==</span> <span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="p">):</span>
        <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;av&#39;</span>
    <span class="n">dvout</span> <span class="o">=</span> <span class="n">DV</span><span class="p">(</span>
        <span class="n">corr</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dv_use</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value_type</span><span class="p">,</span> <span class="n">av_sim_mat</span><span class="p">,</span> <span class="n">strvec</span><span class="p">,</span>
        <span class="n">dv_use</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">stretches</span><span class="o">=</span><span class="n">stretches</span><span class="p">,</span> <span class="n">corrs</span><span class="o">=</span><span class="n">corrs</span><span class="p">,</span>
        <span class="n">n_stat</span><span class="o">=</span><span class="n">n_stat</span><span class="p">,</span> <span class="n">dv_processing</span><span class="o">=</span><span class="n">dv_use</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dv_processing</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dvout</span></div>


<div class="viewcode-block" id="average_dvs_by_coords"><a class="viewcode-back" href="../../../modules/API/API.html#seismic.monitor.monitor.average_dvs_by_coords">[docs]</a><span class="k">def</span> <span class="nf">average_dvs_by_coords</span><span class="p">(</span>
    <span class="n">dvs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DV</span><span class="p">],</span> <span class="n">lat</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">lon</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">el</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1e6</span><span class="p">,</span> <span class="mf">1e6</span><span class="p">),</span> <span class="n">return_std</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DV</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Averages the Similariy matrix of the DV objects if they are inside of the</span>
<span class="sd">    queried coordionates. Based on those,</span>
<span class="sd">    it computes a new dv value and a new correlation value.</span>

<span class="sd">    :param dvs: List of dvs from the different components to compute an</span>
<span class="sd">        average from. Note that it is possible to use almost anything as</span>
<span class="sd">        input as long as the similarity matrices of the dvs have the same shape</span>
<span class="sd">    :type dvs: List[class:`~seismic.monitor.dv.DV`]</span>
<span class="sd">    :param lat: Minimum and maximum latitude of the stations(s). Note that</span>
<span class="sd">        for cross-correlations both stations must be inside of the window.</span>
<span class="sd">    :type lat: Tuple[float, float]</span>
<span class="sd">    :param lon: Minimum and maximum longitude of the stations(s). Note that</span>
<span class="sd">        for cross-correlations both stations must be inside of the window.</span>
<span class="sd">    :type lon: Tuple[float, float]</span>
<span class="sd">    :param el: Minimum and maximum elevation of the stations(s) in m. Note that</span>
<span class="sd">        for cross-correlations both stations must be inside of the window.</span>
<span class="sd">        Defaults to (-1e6, 1e6) - i.e., no filter.</span>
<span class="sd">    :type el: Tuple[float, float], optional</span>
<span class="sd">    :param return_std: Save the standard deviation of the similarity</span>
<span class="sd">        matrices into the dv object. Defaults to False.</span>
<span class="sd">    :type return_std: bool, optional</span>
<span class="sd">    :raises TypeError: for DVs that were computed with different methods</span>
<span class="sd">    :return: A single dv with an averaged similarity matrix.</span>
<span class="sd">    :rtype: DV</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dv_filt</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">dvs</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">stats</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">channel</span> <span class="o">==</span> <span class="s1">&#39;av&#39;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Averaging of averaged dvs not allowed. Skipping dv&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">((</span>
            <span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="o">.</span><span class="n">stla</span> <span class="o">&lt;=</span> <span class="n">lat</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="o">.</span><span class="n">evla</span> <span class="o">&lt;=</span> <span class="n">lat</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="o">.</span><span class="n">stlo</span> <span class="o">&lt;=</span> <span class="n">lon</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="o">.</span><span class="n">evlo</span> <span class="o">&lt;=</span> <span class="n">lon</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="o">.</span><span class="n">stel</span> <span class="o">&lt;=</span> <span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="o">.</span><span class="n">evel</span> <span class="o">&lt;=</span> <span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
            <span class="n">dv_filt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dv</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">dv_filt</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;No DVs within geographical constraints found.&#39;</span><span class="p">)</span>
    <span class="n">av_dv</span> <span class="o">=</span> <span class="n">average_components</span><span class="p">(</span><span class="n">dv_filt</span><span class="p">,</span> <span class="n">return_std</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">av_dv</span><span class="o">.</span><span class="n">stats</span>
    <span class="c1"># adapt header</span>
    <span class="n">s</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;geoav&#39;</span>
    <span class="n">s</span><span class="p">[</span><span class="s1">&#39;stel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;evel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">el</span>
    <span class="n">s</span><span class="p">[</span><span class="s1">&#39;stlo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;evlo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon</span>
    <span class="n">s</span><span class="p">[</span><span class="s1">&#39;stla&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;evla&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat</span>
    <span class="k">return</span> <span class="n">av_dv</span></div>


<div class="viewcode-block" id="average_components_wfc"><a class="viewcode-back" href="../../../modules/API/API.html#seismic.monitor.monitor.average_components_wfc">[docs]</a><span class="k">def</span> <span class="nf">average_components_wfc</span><span class="p">(</span><span class="n">wfcs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">WFC</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">WFC</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Averages the Similariy matrix of the three DV objects. Based on those,</span>
<span class="sd">    it computes a new dv value and a new correlation value.</span>

<span class="sd">    :param dvs: List of dvs from the different components to compute an</span>
<span class="sd">            average from. Note that it is possible to use almost anything as</span>
<span class="sd">            input (also from different stations). However, at the time,</span>
<span class="sd">            the function requires the input to be of the same shape</span>

<span class="sd">    :type dvs: List[class:`~seismic.monitor.wfc.WFC`]</span>
<span class="sd">    :raises TypeError: for DVs that were computed with different methods</span>
<span class="sd">    :return: A single dv with an averaged similarity matrix</span>
<span class="sd">    :rtype: DV</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">wfcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">)</span>
    <span class="n">wfcp</span> <span class="o">=</span> <span class="n">wfcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">wfc_processing</span>
    <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;av&#39;</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tw_start&#39;</span><span class="p">,</span> <span class="s1">&#39;tw_len&#39;</span><span class="p">,</span> <span class="s1">&#39;freq_min&#39;</span><span class="p">,</span> <span class="s1">&#39;freq_max&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">wfcp</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="n">wfc</span><span class="o">.</span><span class="n">wfc_processing</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">wfc</span> <span class="ow">in</span> <span class="n">wfcs</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not allowed to differ.&#39;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">meandict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">wfcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">meandict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">([</span><span class="n">wfc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">wfc</span> <span class="ow">in</span> <span class="n">wfcs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">wfcout</span> <span class="o">=</span> <span class="n">WFC</span><span class="p">(</span><span class="n">meandict</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">wfcp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wfcout</span></div>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      Â© Copyright 2023, The SeisMIC development team..
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>